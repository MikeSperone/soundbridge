#!/usr/bin/env node

var app    = require("../app");
var server = require('http').Server(app);
var io	   = require('socket.io')(server);

var onError = require('./errorLog');

const constants = require('../config/server-config');

const DEBUG = process.env.NODE_ENV === "development";
const PORT = constants.PORT;

const User = require('./userEvents');
const users = {
    all: {},
    performer: {},
    audience: {}
};

/**
*  Setting Numbers
*/
const newSetting = function() {
    const i = Math.floor(Math.random() * 29);
    console.info("Setting changed to " + i);
    return i;
};

var currentSetting = newSetting();

io.on('connection', function(socket){

    const user = new User(socket);
    user.connected();
    users.all[user.uuid] = user;

    const numberOfUsers = io.engine.clientsCount;
    console.info('users connected: ', numberOfUsers);

    socket.on('user-exit', user.exit);
    socket.on('disconnect', () => {
        delete(users['all'][user.uuid]);
        if (user.type && user.uuid && users[user.type][user.uuid]) {
            console.info('disconnecting user ', user);
            delete(users[user.type][user.uuid]);
        }
        user.disconnected();
    })

    var userType = 'performer';

    console.info(Object.keys(users.performer).length, ' performers');
    if (Object.keys(users.performer).length >= 4) {
        userType = 'audience';
    }

    user.join(userType, currentSetting);
    users.audience[user.uuid] = user;
    if (userType === 'audience') return;

    function emit(name, data) {
        DEBUG && console.info(name + ": ", data);
        socket.emit(name, data);
    }

    //TODO: I guess eventually, this should go outside of this function.
    // BUT, also it should go per "room", not overall - right?
    setInterval(function(){
        currentSetting = newSetting();
        // this socket is the part I'll need to consider.  It doesn't exist
        // above, so :/
        socket.emit('setting', { currentSetting });
    }, 60 * 1000 * 30);

    socket.on('data', function(d) {
        socket.broadcast.emit('data', d);
    });
    socket.on('enter', function(d) {
        socket.broadcast.emit('enter', d);
    });
    socket.on('exit', function(d) {
        socket.broadcast.emit('exit', d);
    });
    socket.on('login', function(d) {
        console.log('login', d);
        socket.broadcast.emit('user.joined', d);
    });
    socket.on('logout', function(d) {
        console.log('logout', d);
        socket.broadcast.emit('user.left', d);
    });

});

console.log('connecting...');
server.on('error', onError);

server.listen(Number(PORT), function() {
    console.log('connected to port ' + PORT);
});

